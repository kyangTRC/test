<!DOCTYPE html>
<html>
<body>
<p id="demo"></p>
<p id="test"></p>
<script src="./jquery.min.js"></script>
<script src="./xml2json.js"></script>
<script>
/* HELPER FUNCTION */
function createCORSRequest(method, url) {
    let xhr = new XMLHttpRequest();
    if ("withCredentials" in xhr) {
      // Check if the XMLHttpRequest object has a "withCredentials" property.
      // "withCredentials" only exists on XMLHTTPRequest2 objects.
      xhr.open(method, url, true);
      } else if (typeof XDomainRequest != "undefined") {
        // Otherwise, check if XDomainRequest.
        // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
        xhr = new XDomainRequest();
        xhr.open(method, url);
      } else {
        // Otherwise, CORS is not supported by the browser.
        xhr = null;
      }
      return xhr;
}

/* STEP 1 -- FETCH SIK -- */
////////////////////////////////////////////////
const account_user = ["TRCSolutions", "ActUser"];

const t_account_user = ["CRESALES", "TRCTEST"];

let sLoginRequest = "http://parcelstream.com/admin/getSIK.aspx?ACCOUNT=" + t_account_user[0] + "&LOGIN=" + t_account_user[1];

let wkt = "LINESTRING (-95.9621226483684 36.066442984799,-95.9630934684588 36.0657434232634,-95.9630934684588 36.0641015951692,-95.9621226483684 36.0641015951692,-95.9621226483684 36.0611463046)";

var xhrsLoginRequest = createCORSRequest('GET', sLoginRequest);
if (!xhrsLoginRequest) {
  throw new Error('CORS not supported sLoginRequest');
}

function ajaxCall(url) {
  let xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      parseDemo(this);
    }
  };
  xhttp.open("GET", url);
  xhttp.send();
}

function parseDemo(xml) {
  var xmlDoc = xml.response;
  var x2js = new X2JS();
   $("#demo").html(JSON.stringify(x2js.xml_str2json(xmlDoc)));
}

/*
let temp = http://dc2.parcelstream.com/_T94/InitSession.aspx?sik=_T94/decbe835-e666-417a-9f7d-1d1333379f91-101400_570474633&output=xml
*/

/* STEP 2 -- EXTRACT CANDY AND DATA CENTER -- */
////////////////////////////////////////////////
let demoCandy = "xINBuuymZ0px5mpsdeJucHWu5d0xVa9xIidMYQ~~";
let demoWKT = "POLYGON((-117.68585039585565%2033.62778144479256,-117.68514229267572%2033.62718290521123,-117.68509937733148%2033.62689703409304,-117.6852817675445%2033.62687916711664,-117.6861293455932%2033.627575976449805,-117.68585039585565%2033.62778144479256))";
let demoUrl = `http://dc1.parcelstream.com/getQuery.aspx?datasource=SS.Prop.ParcelDetail/ParcelDetail&geo=`+demoWKT+`&SS_Candy=`+demoCandy+`&fields=SITE_ADDRESS,SITE_CITY,SITE_STATE,SITE_ZIPCODE,COUNTY,APN,LOCATION_ID,_DMP_ID`;

let xhrdemoUrl = createCORSRequest('GET', demoUrl);
if (!xhrdemoUrl) {
  throw new Error('CORS not supported demoUrl');
}
/* STEP 3 -- ACCESS PARCEL DETAILS -- */
////////////////////////////////////////////////
ajaxCall(demoUrl);
/* STEP 4 -- ACCESS DOCUMENT IMAGES -- */
////////////////////////////////////////////////
</script>
</body>
</html>
